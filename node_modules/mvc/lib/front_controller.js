//import modules
var url = require('url'),
    stringUtils = require('./utils/string'),
    fs = require('fs'),
    path = require('path'),
    route = require('./route'),
    oo = require('./utils/oo'),
    Config = require('./config');


var FrontController = function(options){
    this._initFrontController(options);
};

FrontController.prototype = {
    _initFrontController: function(options){
        this.options = {
            intent: {}
        };
        this.options = oo.mix(this.options, options);
    },
    /**
     * 根据给定的文件名判断是否为文件
     * @param fileName
     * @param callback
     */
    isFile: function(fileName, callback){
        fs.stat(fileName, function(err, stats){
            var status = false;
            if(!err && stats.isFile()){
                status = true;
            }

            callback(status, stats, fileName);
        });

    },

    route: function(){
        var self = this;
        var fileName = Config.file_path + this.options.intent.request.url;
        this.isFile(fileName, function(status, stats, fname){
            if(status){
                self.responseFile(fname, stats);
            }else{
                route.addRoutes(Config.routes);
                route.dispatch(self.options.intent);
            }
        })
    },

    responseFile: function(fileName, stats){
        var self = this;
        var ext = stringUtils.trim(path.extname(fileName), '\\.');
        var mimeTypes = require('./MIME').types;
        var ifModifiedSince = this.options.intent.request.headers['if-modified-since'];
        if(ifModifiedSince){
            var ifModifiedSinceTime = new Date(ifModifiedSince).getTime();
            var fileModifyTime = new Date(stats.mtime).getTime();

            if(ifModifiedSinceTime == fileModifyTime){
                self.options.intent.response.writeHead(304);
                self.options.intent.response.end();
                return;
            }
        }

        var data = fs.readFileSync(fileName, 'binary')
        self.options.intent.response.writeHead(200,
            {
                'Content-Type': mimeTypes[ext],
                'Date': new Date(),
                'Cache-Control': 'max-age=600000',
                'Expires': new Date(new Date().getTime() + 86400000),
                'Last-Modified': stats.mtime
            });
        self.options.intent.response.end(data, 'binary');
    }
}

module.exports = FrontController;
